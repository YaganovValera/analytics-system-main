# Архитектура системы аналитики рынка цифровых активов

## 1. Обзор
Система представляет собой набор микросервисов для приёма, обработки, агрегации и предоставления аналитики по рыночным данным криптобирж в реальном времени. Ключевые цели:
- Высокая пропускная способность и устойчивость к пиковым нагрузкам.
- Горизонтальное масштабирование компонентов по мере роста объёмов данных.
- Чёткое разделение ответственности между сервисами.
- Единые контракты взаимодействия через gRPC/Protobuf.
- Детальная телеметрия и мониторинг для быстрого обнаружения и устранения проблем.

Стек технологий:
- Язык программирования: Go.
- Очередь сообщений: Kafka.
- Кэширование: Redis.
- СУБД: Postgres.
- Контейнеризация: Docker, оркестрация: Kubernetes.
- Мониторинг: OpenTelemetry + Prometheus + Grafana.

## 2. Компоненты системы

### 2.1 Микросервисы (`services/`)
- **analytics-api**: gRPC/REST API для внешних клиентов, агрегирует результаты аналитики из хранилища.
- **api-gateway**: единственная входная точка для HTTP-запросов, маршрутизация к внутренним сервисам, аутентификация.
- **auth**: сервис аутентификации/авторизации JWT, управляет пользователями и правами доступа.
- **market-data-collector**: консьюмер WebSocket API криптобиржи, публикует сырые события в Kafka.
- **preprocessor**: консьюмер Kafka, фильтрация, валидация и агрегация событий, запись в Postgres и Redis.

Каждый сервис построен по шаблону:
```
cmd/          — точка входа (main.go)
config/       — YAML-конфигурации
internal/     — реализация бизнес-логики
pkg/          — публичные библиотеки (если нужны)
Dockerfile    — инструкция сборки контейнера
go.mod/sum    — зависимости
```  

### 2.2 Общие библиотеки (`common/`)
Используются во всех сервисах через `replace` в `go.work`:
- **kafka**: инициализация продьюсеров/консьюмеров.
- **logging**: обёртка над `zap`/`logrus` с поддержкой контекстных полей.
- **metrics**: регистрация Prometheus-метрик.
- **redis**: клиентская инициализация и утилиты кэширования.

## 3. Структура репозитория

```
project-root/
├── services/                # Код микросервисов
│   ├── analytics-api/
│   ├── api-gateway/
│   ├── auth/
│   ├── market-data-collector/
│   └── preprocessor/
├── common/                  # Общие библиотеки
│   ├── kafka/
│   ├── logging/
│   ├── metrics/
│   └── redis/
├── proto/                   # Protobuf-контракты и генерация
│   ├── v1/
│   └── v2/
├── infra/                   # Инфраструктурные манифесты
│   ├── docker-compose.yml
│   ├── k8s/                 # Deployment, Service, Helm
│   ├── monitoring/          # Prometheus, Grafana, OTel
│   └── secrets/             # Vault, External-Secrets
├── docs/                    # Документация проекта
│   └── architecture.md
├── go.work*                 # Объединение модулей монорепо
├── Makefile                 # Общие команды сборки и тестирования
└── README.md                # Краткое описание и инструкции по запуску
```

## 4. CI/CD
- Единый pipeline (GitHub Actions/GitLab CI) в корне:
  1. Линтинг и `go fmt`.
  2. Unit-тесты и проверка покрытия.
  3. Сборка Docker-образов.
  4. Security scan (например, `gosec`).
  5. Деплой в staging/production через Helm-чарты.

## 5. Мониторинг и телеметрия
- **OpenTelemetry**: SDK и экспортеры встроены в каждый сервис для трейсинга.
- **Prometheus**: сбор метрик через HTTP-эндпоинт `/metrics`.
- **Grafana**: дашборды по latency, throughput, ошибкам и загруженности брокеров.

## 6. Соглашения по кодированию
- Кодировка UTF-8, LF.
- `internal/` для скрытых пакетов, `pkg/` — для публичных библиотек.
- Комментарии к экспортируемым сущностям в `Godoc` формате.
- Контракты Protobuf версифицируемы: backward/forward-совместимость.
- Обработка ошибок: использование `errors.Wrap` (или `%w`) и централизованный middleware для логирования.


### internal/
- `app/collector.go` — точка входа, orchestrator всех компонентов.
- `config/` — загрузка и валидация конфигурации.
- `http/` — HTTP-сервер для /metrics, /healthz, /readyz.
- `processor/` — бизнес-логика разбора и подготовки сообщений.
- `metrics/` — регистрация и Handler для Prometheus.
- `telemetry/` — инициализация OpenTelemetry.

---
*Документ обновлён: 28 апреля 2025*

