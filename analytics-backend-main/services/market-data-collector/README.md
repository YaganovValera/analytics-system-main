
# market-data-collector

üì° **`market-data-collector`** ‚Äî —ç—Ç–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å —Å–∏—Å—Ç–µ–º—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –¥–ª—è —Å–±–æ—Ä–∞ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å Binance WebSocket API –∏ –∏—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Apache Kafka. –û–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω—É—é –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é —Å–æ–±—ã—Ç–∏–π —Ç–∏–ø–∞ `trade` –∏ `depthUpdate` —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å—é.

---

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

- üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Binance WebSocket (—Å backoff, ping, reconnect).
- üì¶ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ—Ç–æ–∫–æ–≤ `trade` –∏ `depthUpdate` –ø–æ –º–Ω–æ–∂–µ—Å—Ç–≤—É —Å–∏–º–≤–æ–ª–æ–≤.
- üì§ –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –≤ Kafka –≤ —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ Protobuf.
- üìä –ú–µ—Ç—Ä–∏–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Prometheus (`/metrics`).
- ‚ù§Ô∏è Health/readiness –ø—Ä–æ–±—ã –¥–ª—è Kubernetes.
- üìà –ì–∏–±–∫–∞—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è (flush, batching) –∏ —Å–∂–∞—Ç–∏–µ Kafka —Å–æ–æ–±—â–µ–Ω–∏–π.

---

## üß© –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```text
           Binance WS
               ‚Üì
     [market-data-collector]
               ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ trade stream ‚îÇ depth stream‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚Üì
         Apache Kafka
               ‚Üì
      (–¥—Ä—É–≥–∏–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã)
````

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ `config/config.yaml`, –Ω–æ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `MARKETDATA_`.

### –ü—Ä–∏–º–µ—Ä—ã –∫–ª—é—á–µ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫:

```yaml
binance:
  ws_url: "wss://stream.binance.com:9443/ws"
  streams:
    - "btcusdt@trade"
    - "btcusdt@depth"
  read_timeout: "30s"

kafka:
  brokers: ["kafka:9092"]
  raw_topic: "marketdata.raw"
  orderbook_topic: "marketdata.orderbook"
  flush_frequency: "100ms"
  flush_messages: 100
  compression: "gzip"
```

---

## üß™ –ú–µ—Ç—Ä–∏–∫–∏

–≠–∫—Å–ø–æ–Ω–∏—Ä—É—é—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:8086/metrics`

| –ú–µ—Ç—Ä–∏–∫–∞                             | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                       |
| ----------------------------------- | -------------------------------- |
| `processor_events_total`            | –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π         |
| `processor_parse_errors_total`      | –û—à–∏–±–∫–∏ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ JSON         |
| `processor_serialize_errors_total`  | –û—à–∏–±–∫–∏ –ø—Ä–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ protobuf |
| `processor_publish_errors_total`    | –û—à–∏–±–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Kafka        |
| `processor_publish_latency_seconds` | –ó–∞–¥–µ—Ä–∂–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏              |

---

## üõ°Ô∏è Kubernetes

–í—Å–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã Kubernetes –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤:

```
/deploy/k8s/market-data-collector/
```

–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:

```bash
kubectl apply -k deploy/k8s/market-data-collector
```

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

* `deployment.yaml` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ Pod –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
* `service.yaml` ‚Äî –∫–ª–∞—Å—Ç–µ—Ä–Ω—ã–π —Å–µ—Ä–≤–∏—Å (–ø–æ—Ä—Ç `8086`).
* `configmap.yaml` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (`config.yaml`).
* `livenessProbe`, `readinessProbe` ‚Äî `/healthz`, `/readyz`.

---

## üê≥ –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ (—á–µ—Ä–µ–∑ Docker)

```bash
docker build -t market-data-collector -f Dockerfile .
docker run --rm -p 8086:8086 market-data-collector --config config/config.yaml
```

---

## üìå –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

* Binance WebSocket API
* Apache Kafka
* Prometheus (–¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫)
* TimescaleDB (–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ ‚Äî downstream consumer)
* Protobuf (–¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π)

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
‚îú‚îÄ‚îÄ cmd/collector          # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ config/config.yaml     # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ internal/              # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ app                # Run(...) orchestrator
‚îÇ   ‚îú‚îÄ‚îÄ processor          # trade / depth –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ transport/binance  # ws-manager, client
‚îú‚îÄ‚îÄ pkg/binance            # WS-connector (low-level)
‚îú‚îÄ‚îÄ Dockerfile             # Multi-stage build
‚îî‚îÄ‚îÄ README.md              # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

---

## üß† –ü–æ—á–µ–º—É –æ–Ω –≤–∞–∂–µ–Ω

–≠—Ç–æ—Ç –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å ‚Äî **—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã —Ä—ã–Ω–æ—á–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏**. –û–Ω –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:

* –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –∑–∞–ø–∏—Å—å "—Å—ã—Ä—ã—Ö" –¥–∞–Ω–Ω—ã—Ö —Å –±–∏—Ä–∂–∏,
* –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–æ—Ç–µ—Ä–∏ –ø—Ä–∏ reconnect,
* —Å–æ–±–ª—é–¥–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ (Kafka + Protobuf),
* —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (—á–µ—Ä–µ–∑ Kubernetes).

---

## üë®‚Äçüíª –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º:

* –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥ `kubectl logs market-data-collector-XYZ`
* –£–±–µ–¥–∏—Å—å, —á—Ç–æ Kafka –¥–æ—Å—Ç—É–ø–µ–Ω (`kafka:9092`)
* –ü—Ä–æ–≤–µ—Ä—å `/metrics` –∏ `/healthz` –Ω–∞ `:8086`

---


